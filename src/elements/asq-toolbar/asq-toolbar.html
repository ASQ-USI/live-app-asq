<link rel="import" href="../../../../polymer/polymer.html">
<link rel="import" href="../../../../paper-slider/paper-slider.html">
<link rel="import" href="../../../../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../../paper-button/paper-button.html">
<link rel="import" href="../../../../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../iron-icons/iron-icons.html">
<link rel="import" href="../../../../iron-icon/iron-icon.html">
<dom-module id="asq-toolbar">
  <style>
    :host{
      --paper-drawer-panel-right-drawer-container: {
        padding: 10px;
      };
    }
    app-toolbar {
      background-color: #CFD8DC;
      font-family: 'Roboto', Helvetica, sans-serif;

      height: 60px;
    }
    #lecture-quality-label{
      font-size: 12px;
      padding: 0 20px;
      text-align: center;
    }
    #sliderContainer{
      display:inline-flex;
    }
    .sliderText{
      font-size: 12px;
      padding-top: 10px;
    }
    #bgDiv{
      position: fixed; 
      top: 0;
      bottom: 0;
      left: 0;
      right: 0; 
      background: transparent;
    }
    #currentSlideText{
      font-size: 0.85em;
      text-align: center;
    }
    #paperDrawerPanel{
      @apply(--layout-fixed-bottom);
    }
    #sendButtonContainer{
      @apply(--layout-horizontal);
      @apply(--layout-end-justified);
    }
    paper-dialog {
      position: fixed;
      top: 0;
      left: 0;
      margin: 0px;
      height: 92%;
      width: 100%;
    }
    .questionsDiv {
      overflow-y: scroll;
      /*This property is needed otherwise it won't scroll!!!*/
      height: 83%;
    }
    #dialogHeader {
      font-size: 2.0em;
      line-height: 2;
    }
    #dialogContent > p {
      font-size: -webkit-xxx-large;
      line-height: 1;
    }
    #dialogContent {
      height: 77%;
      overflow-y: scroll;
    }
    ::-webkit-scrollbar{
      width: 0px;
    }
    .container {
      display: flex;
      color: black;
      background: white;
      margin: 3px auto;
      padding: 5px;
    }
    .questionDataContainer {
      flex: 1;
      @apply(--layout-horizontal);
      @apply(--layout-start);
    }
    .slideInfo {
      width: 100px;
      font-size: 0.8em;
      color: #696969;
    }
    .slideInfoHeader{
      font-size: 1em;
      color: white;
    }
    .questionData {
      flex: 1;
      overflow-y: scroll;
    }
    .userInfo {
      width: 140px;
    }
    .votingInfo{
      width: 120px;
      @apply(--layout-horizontal);
      @apply(--layout-end-justified);
    }
    .up {
      color: #66BB6A;
      padding: 0;
      height: 20px;
      --iron-icon: {
        height: 20px;
      };   
    }
    .down {
      color: #EF5350;
      height: 20px;
      /*padding-left: 10px;*/
      padding: 0;
      height: 20px;
      --iron-icon: {
        height: 20px;
      }; 
    }

    .thumb-container{
      @apply(--layout-horizontal);
      @apply(--layout-center);
      overflow-x: hidden;
    }

    .thumb-score{
      font-size: 0.9em;
      padding-top: 1px;
    }

    .textWrap {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
  </style>
  <template>
    <app-toolbar id="toolbar" main>
      <div>
        <div id="lecture-quality-label">How well do you understand this slide?</div>
        <div id="sliderContainer">
          <span class="sliderText">I am lost</span>
          <paper-slider min="0" max="100" value="{{sliderValue}}" on-change="sliderChange"></paper-slider>
          <span class="sliderText">I get it</span>
        </div>
      </div>
      <div main-title></div>
      <paper-button icon="menu" on-tap="_togglePanel"> Ask a question </paper-button>
      <paper-drawer-panel selected="{{_paperDrawerSelected}}" id="paperDrawerPanel" force-narrow="true" right-drawer drawer-width="500px">
          <div drawer id="paperDrawerPanelDiv"> 
            <div id="currentSlideText"> {{_currentSlide}} </div>
            <paper-textarea id="textArea" label="Enter your question or remark here"></paper-textarea>
            <div id="sendButtonContainer">
              <paper-button icon="menu" on-tap="_sendQuestion" raised id="sendButton">
              Send
            </paper-button>
            </div>
            <div class="questionsDiv">
              <template is="dom-repeat" items="[[questions]]">
                <div class="container">
                  <div class="questionDataContainer">
                    <div class="slideInfo textWrap">{{item.submission.slide}}</div>
                    <div class="questionData">
                      <div class="questionContent">{{item.submission.value}}</div>
                    </div>
                    <div class="userInfo textWrap">{{item.submission.user}}</div>
                    <div class="votingInfo">
                    <div class="thumb-container">
                      <paper-icon-button icon="icons:thumb-up" class="up" on-tap="_upvoteQuestion"></paper-icon-button>
                      <div class="thumb-score">{{item.upvotes.length}}</div>
                    </div>
                    <div class="thumb-container">
                      <paper-icon-button icon="icons:thumb-down" class="down" on-tap="_downvoteQuestion"></paper-icon-button>
                      <div class="thumb-score"> {{item.downvotes.length}}</div>
                    </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
      </paper-drawer-panel>
    </app-toolbar>
    <paper-dialog id="dialog" opened="{{_paperDialogOpened}}">
      <h2 id="dialogHeader">User {{question.submission.user}} asks:</h2>
      <div id="dialogContent">
        <p>{{question.submission.value}}</p>
      </div>
      <div class="buttons">
        <div id="thumbUpDiv">
          <paper-icon-button icon="icons:thumb-up" on-tap="_upvoteQuestion" class="up"></paper-icon-button>
          <span>{{question.upvotes.length}}</span>
        </div>
        <div id="thumbDownDiv">
          <paper-icon-button icon="icons:thumb-down" on-tap="_downvoteQuestion" class="down"></paper-icon-button>
          <span>{{question.downvotes.length}}</span>
        </div>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is:'asq-toolbar',
      properties:{
        sliderValue:{
          type: Number,
          value: 50
        },
        _isPaperDrawerOpen : {
          type: Boolean,
          computed: '_paperDrawerSelectedChanged(_paperDrawerSelected)'
        },
        _paperDrawerSelected: {
          type: String,
          notify: true
        },
        _paperDialogOpened: {
          type: Boolean,
          notify: true,
        },
        _isPaperDialogOpen : {
          type: Boolean,
          computed: '_paperDialogOpenedChanged(_paperDialogOpened)'
        },
        _currentSlide: {
          type: String,
          notify: true
        },
        _answerStartTime: {
          type: Date
        },
        question: {
          type: Object,
          notify:true,
          observer: '_showQuestion',
        },
        questions: {
          type: Array,
          notify: true,
        },

      },
      observers: [
        '_updatePointerEvents(_isPaperDrawerOpen, _isPaperDialogOpen)',
      ],
      setElementPointerEvents: function(element, pointerEvents) {
        element.style.pointerEvents = pointerEvents;
      },

      getPaperDrawerPanel: function (){
        return this.$.paperDrawerPanel
      },

      getTextArea: function() {
        return this.$.textArea;
      },

      getPaperDialog: function () {
        return this.$.dialog;
      },

      getDialogContent: function () {
        return this.$.dialogContent;
      },

      getSendButton: function () {
        return this.$.sendButton;
      },

      getSlideNameFromWindow: function() {
        return window.location.hash.split('/')[1];
      },

      getCurrentSlide: function() {
        return this._currentSlide
      },

      getAnswerStartTime: function() {
        return this._answerStartTime;
      },

      setCurrentSlide: function (name) {
        this.set('_currentSlide', name); 
      },

      setAnswerStartTime: function (date) {
        this.set('_answerStartTime', date);
      },

      _isDrawerOpen: function () {
        return this._isPaperDrawerOpen;
      },

      _isDialogOpen: function () {
        return this._isPaperDialogOpen;
      },

      _paperDrawerSelectedChanged: function(val) {
        return val === 'drawer';
      },

      _paperDialogOpenedChanged(val) {
        return val;
      },

      _openPaperDialog() {
        const dialog = this.getPaperDialog();
        dialog.open();
      },

      sliderChange: function () {
        const event = {
          data:{
            value: this.sliderValue
          },
          type:'student-perception-change',
        };
        this._sendLiveAppEvent(event)
      },

      _sendLiveAppEvent: function(event) {
        this.fire('live-app', event)
      },

      _sendQuestion: function() {
        const textArea = this.getTextArea();
        const text = textArea.value;
        // User has not inserted any text
        if (typeof text === 'undefined') return;
        // trim() removes whitespaces
        const content = text.trim();
        if (content.length === 0) return;
        const currentSlide = this.getCurrentSlide();
        const answerStartTime = this.getAnswerStartTime();
        const sumbissionDate = new Date();
        const event = {
          answerStartTime,
          sumbissionDate,
          data:{
            slide: currentSlide,
            value: content
          },
          type:'student-question-submitted',
        }
        this._sendLiveAppEvent(event);
        textArea.value = '';
        this._handleBtnTimeout();
      },

      _togglePanel: function () {
        const drawer = this.getPaperDrawerPanel();
        drawer.togglePanel();
        if(this._isDrawerOpen()){
          const slideName = this.getSlideNameFromWindow();
          this.setCurrentSlide(slideName);
          const currentDate = new Date();
          this.setAnswerStartTime(currentDate);
        }
      },

      _updateDrawerPointerEvents: function() {
        const drawer = this.getPaperDrawerPanel();
        let ptrEvents = 'none';
        if(this._isDrawerOpen()){
          ptrEvents = 'auto';
        }
        this.setElementPointerEvents(drawer, ptrEvents);
      },

      _updateDialogPointerEvents: function() {
        const dialog = this.getPaperDialog();
        let ptrEvents = 'none';
        if(this._isDialogOpen()){
          ptrEvents = 'auto';
        }
        this.setElementPointerEvents(dialog, ptrEvents);

      },

      _updatePointerEvents: function() {
        this._updateDrawerPointerEvents();
        this._updateDialogPointerEvents();
      },

      _showQuestion: function () {
        const dialog = this.getPaperDialog();
        this._openPaperDialog();
      },

      _upvoteQuestion: function (e) {
        let question;
        // This is made so I can differentiate if it's an upvote from the modal or from the paper drawer
        if (e.model === undefined) {
          question = this.question;
        } else {
          question = e.model.item;
        }
        const event = {
          type: 'student-question-rated',
          data: {
            upvote: true,
            question,
          }
        };
        this._sendLiveAppEvent(event);
      },

      _downvoteQuestion: function (e) {
        let question;
        if (e.model === undefined) {
          question = this.question;
        } else {
          question = e.model.item;
        }
        const event = {
          type: 'student-question-rated',
          data: {
            downvote: true,
            question,
          }
        };
        this._sendLiveAppEvent(event);
      },

      _handleBtnTimeout: function () {
        const button = this.getSendButton();
        let seconds = 5;
        const btnText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = 'Question submitted wait ' + seconds +'s';
        const interval = setInterval(function() {
          seconds--;
          if (seconds === 0) {
            clearInterval(interval);
            button.innerHTML = btnText;
            button.disabled = false;
            return
          }
          button.disabled = true;
          button.innerHTML = 'Question submitted wait ' + seconds +'s';

        }, 1000);
      },

    })
  </script>
</dom-module>